#!/bin/bash

# /etc/update-motd.d/10-system-status
# don't forget sudo chmod +x /etc/update-motd.d/10-system-status

# Define ANSI color codes
bold=$(tput bold)
normal=$(tput sgr0)
cyan=$(tput setaf 6)
yellow=$(tput setaf 3)

# Get the number of CPU cores
cpu_cores=$(nproc)

# Get the 1-minute load average and remove any trailing commas or extra characters
load_avg_1min=$(uptime | awk -F'load average:' '{ print $2 }' | awk '{ print $1 }' | tr -d ',')

# Calculate CPU usage percentage over the last minute
cpu_usage_1min=$(echo "scale=2; $load_avg_1min / $cpu_cores * 100" | bc)

# Get terminal width
term_width=$(tput cols)

# Define the title
title="< --- Server Status Report --- >"

# Calculate left padding to center the title
padding=$(( (term_width - ${#title}) / 2 ))

# Display centered and bold colored status report title
printf "%*s%s%s%s\n" $padding "" "${bold}${cyan}" "$title" "${normal}"
echo ""

# System resource usage
echo "${bold}${yellow}System Resource Usage:${normal}"
echo "----------------------"
echo "CPU Load (1 min avg): $cpu_usage_1min%"
echo "Memory Usage: $(free -h | grep Mem | awk '{print $3 "/" $2 " used"}')"
echo "Swap Usage: $(free -h | grep Swap | awk '{print $3 "/" $2 " used"}')"
echo "Disk Usage: $(df -h / | grep / | awk '{print $3 " used of " $2}')"
echo ""

# Docker container status
if command -v docker &> /dev/null; then
    echo "${bold}${yellow}Docker Container Status:${normal}"
    echo "------------------------"
    docker ps --format "table {{.Names}}\t{{.Status}}"
else
    echo "${bold}${yellow}Docker is not installed or not running.${normal}"
fi

echo ""

# Incus container status
if command -v incus &> /dev/null; then
    echo "${bold}${yellow}Incus Container Status:${normal}"
    echo "-----------------------"
    incus list --format=table | awk 'NR==1 {print} NR>1 {print}'
else
    echo "${bold}${yellow}Incus is not installed or not running.${normal}"
fi